<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–Ω–∞–∂—ë—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .card {
            background: white;
            color: black;
            padding: 20px;
            border-radius: 15px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            margin: 5px 0;
            width: 100%;
            cursor: pointer;
        }
        .option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            margin: 5px 0;
            transition: all 0.3s;
        }
        .option:hover {
            background: #e9ecef;
        }
        .option.correct {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .option.incorrect {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        .hidden {
            display: none;
        }
        .back-btn {
            background: #6c757d;
            margin-top: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .stat-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 5px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
        #debug {
            position: fixed;
            top: 10px;
            left: 10px;
            background: red;
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 10000;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="debug">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <div class="container">
        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="mainScreen">
            <div style="text-align: center;">
                <h1>üéì –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–Ω–∞–∂—ë—Ä</h1>
                <p>–í–µ—Ä—Å–∏—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º</p>
            </div>

            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div>
                    <div><strong id="userName">–£—á–µ–Ω–∏–∫</strong></div>
                    <div>–£—Ä–æ–≤–µ–Ω—å: <span id="userLevel">–ù–æ–≤–∏—á–æ–∫</span></div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="stats">
                    <div class="stat-item">
                        <div>‚úÖ</div>
                        <div id="totalCorrect">0</div>
                        <small>–ü—Ä–∞–≤–∏–ª—å–Ω–æ</small>
                    </div>
                    <div class="stat-item">
                        <div>üìù</div>
                        <div id="totalAnswered">0</div>
                        <small>–í—Å–µ–≥–æ</small>
                    </div>
                    <div class="stat-item">
                        <div>üéØ</div>
                        <div id="successRate">0%</div>
                        <small>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</small>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìö –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</h3>
                <button onclick="startQuiz('trigonometry')">üìê –¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è</button>
                <button onclick="startQuiz('algebra')">üî¢ –ê–ª–≥–µ–±—Ä–∞</button>
                <button onclick="showProgress()">üìà –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã -->
        <div id="quizScreen" class="hidden">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 id="quizTitle">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞</h2>
                <div>–í–æ–ø—Ä–æ—Å <span id="currentQuestion">1</span> –∏–∑ <span id="totalQuestions">5</span></div>
            </div>
            
            <div class="card">
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px;" id="questionText">
                    –í–æ–ø—Ä–æ—Å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...
                </div>
                
                <div id="optionsContainer">
                    <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
            
            <button class="back-btn" onclick="backToMain()">‚Üê –ù–∞–∑–∞–¥</button>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
        <div id="resultScreen" class="hidden">
            <div class="card">
                <h2 id="resultTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
                <p id="resultMessage"></p>
                <p id="explanationText" style="font-style: italic;"></p>
                <button onclick="nextQuestion()">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
                <button class="back-btn" onclick="backToMain()">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
        <div id="progressScreen" class="hidden">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>üìà –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h2>
            </div>
            
            <div class="card">
                <h3>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="stats">
                    <div class="stat-item">
                        <div>üìö</div>
                        <div id="progressTotalCorrect">0</div>
                        <small>–ü—Ä–∞–≤–∏–ª—å–Ω–æ</small>
                    </div>
                    <div class="stat-item">
                        <div>üìù</div>
                        <div id="progressTotalAnswered">0</div>
                        <small>–í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤</small>
                    </div>
                    <div class="stat-item">
                        <div>‚≠ê</div>
                        <div id="masteredFormulas">0</div>
                        <small>–í—ã—É—á–µ–Ω–æ</small>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º</h3>
                <div id="topicsProgress">
                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
            
            <button class="back-btn" onclick="backToMain()">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const debug = document.getElementById('debug');
        let userProgress = {};
        let userId = '';
        let currentTopic = '';
        let currentQuestionIndex = 0;

        // –ë–∞–∑–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ —Å formulaId –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        const questions = {
            trigonometry: [
                {
                    formulaId: 'sin_90',
                    question: "–ß–µ–º—É —Ä–∞–≤–µ–Ω sin(90¬∞)?",
                    options: ["0", "1", "-1", "0.5"],
                    correct: 1,
                    explanation: "sin(90¬∞) = 1 - —ç—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–∏–Ω—É—Å–∞"
                },
                {
                    formulaId: 'cos_0', 
                    question: "–ß–µ–º—É —Ä–∞–≤–µ–Ω cos(0¬∞)?",
                    options: ["0", "1", "-1", "0.5"],
                    correct: 1,
                    explanation: "cos(0¬∞) = 1 - —ç—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ—Å–∏–Ω—É—Å–∞"
                },
                {
                    formulaId: 'sin_sum',
                    question: "–ß–µ–º—É —Ä–∞–≤–µ–Ω sin(Œ± + Œ≤)?",
                    options: ["sinŒ±cosŒ≤ - cosŒ±sinŒ≤", "sinŒ±cosŒ≤ + cosŒ±sinŒ≤", "cosŒ±cosŒ≤ - sinŒ±sinŒ≤", "sinŒ± + sinŒ≤"],
                    correct: 1,
                    explanation: "sin(Œ± + Œ≤) = sinŒ±cosŒ≤ + cosŒ±sinŒ≤ - —Ñ–æ—Ä–º—É–ª–∞ —Å–∏–Ω—É—Å–∞ —Å—É–º–º—ã"
                }
            ],
            algebra: [
                {
                    formulaId: 'square_sum',
                    question: "–ß–µ–º—É —Ä–∞–≤–µ–Ω (a + b)¬≤?",
                    options: ["a¬≤ + 2ab + b¬≤", "a¬≤ + b¬≤", "a¬≤ - 2ab + b¬≤", "a¬≤ - b¬≤"],
                    correct: 0,
                    explanation: "(a + b)¬≤ = a¬≤ + 2ab + b¬≤ - —Ñ–æ—Ä–º—É–ª–∞ –∫–≤–∞–¥—Ä–∞—Ç–∞ —Å—É–º–º—ã"
                }
            ]
        };

        // –°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π
        const levels = {
            1: { name: "–ù–æ–≤–∏—á–æ–∫", required: 0 },
            2: { name: "–£—á–µ–Ω–∏–∫", required: 5 },
            3: { name: "–ó–Ω–∞—Ç–æ–∫", required: 15 },
            4: { name: "–≠–∫—Å–ø–µ—Ä—Ç", required: 30 },
            5: { name: "–ú–∞—Å—Ç–µ—Ä", required: 50 }
        };

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è debug
        function updateDebug(message) {
            if (debug) {
                debug.textContent = message;
            }
            console.log('DEBUG:', message);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function initUser() {
            // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                const telegramUser = Telegram.WebApp.initDataUnsafe.user;
                userId = telegramUser.id.toString();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                document.getElementById('userName').textContent = telegramUser.first_name || '–£—á–µ–Ω–∏–∫';
                document.getElementById('userAvatar').textContent = telegramUser.first_name ? telegramUser.first_name[0].toUpperCase() : 'U';
            } else {
                // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                userId = 'test_user_' + Date.now();
                document.getElementById('userName').textContent = '–£—á–µ–Ω–∏–∫ (—Ç–µ—Å—Ç)';
                document.getElementById('userAvatar').textContent = 'T';
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            loadUserProgress();
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserProgress() {
            const savedProgress = localStorage.getItem(`math_progress_${userId}`);
            
            if (savedProgress) {
                userProgress = JSON.parse(savedProgress);
                updateDebug('–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω');
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
                userProgress = {
                    userId: userId,
                    totalCorrect: 0,
                    totalAnswered: 0,
                    formulas: {},
                    level: 1,
                    createdAt: new Date().toISOString()
                };
                updateDebug('–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å');
            }
            
            updateUserStats();
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        function saveUserProgress() {
            localStorage.setItem(`math_progress_${userId}`, JSON.stringify(userProgress));
            updateUserStats();
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
        function updateUserStats() {
            document.getElementById('totalCorrect').textContent = userProgress.totalCorrect || 0;
            document.getElementById('totalAnswered').textContent = userProgress.totalAnswered || 0;
            
            const successRate = userProgress.totalAnswered > 0 
                ? Math.round((userProgress.totalCorrect / userProgress.totalAnswered) * 100) 
                : 0;
            document.getElementById('successRate').textContent = successRate + '%';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
            const userLevel = calculateUserLevel();
            document.getElementById('userLevel').textContent = levels[userLevel].name;
        }

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function calculateUserLevel() {
            const totalCorrect = userProgress.totalCorrect || 0;
            
            for (let level = 5; level >= 1; level--) {
                if (totalCorrect >= levels[level].required) {
                    userProgress.level = level;
                    return level;
                }
            }
            return 1;
        }

        // –ó–∞–ø—É—Å–∫ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
        function startQuiz(topic) {
            updateDebug('–ó–∞–ø—É—Å–∫–∞–µ–º –≤–∏–∫—Ç–æ—Ä–∏–Ω—É: ' + topic);
            
            currentTopic = topic;
            currentQuestionIndex = 0;
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã
            shuffleArray(questions[topic]);
            
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            document.getElementById('resultScreen').classList.add('hidden');
            
            const titles = {
                trigonometry: 'üìê –¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è',
                algebra: 'üî¢ –ê–ª–≥–µ–±—Ä–∞'
            };
            document.getElementById('quizTitle').textContent = titles[topic] || topic;
            document.getElementById('totalQuestions').textContent = questions[topic].length;
            
            showQuestion();
        }
        
        // –ü–æ–∫–∞–∑ –≤–æ–ø—Ä–æ—Å–∞
        function showQuestion() {
            const topicQuestions = questions[currentTopic];
            
            if (!topicQuestions || currentQuestionIndex >= topicQuestions.length) {
                updateDebug('–í–æ–ø—Ä–æ—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å');
                backToMain();
                return;
            }
            
            const question = topicQuestions[currentQuestionIndex];
            const optionsContainer = document.getElementById('optionsContainer');
            
            optionsContainer.innerHTML = '';
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
            const shuffledOptions = [...question.options];
            shuffleArray(shuffledOptions);
            const correctAnswerIndex = shuffledOptions.indexOf(question.options[question.correct]);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
            shuffledOptions.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.onclick = function() {
                    checkAnswer(index, correctAnswerIndex, question.formulaId, question.explanation);
                };
                optionsContainer.appendChild(optionElement);
            });
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞
        function checkAnswer(selectedIndex, correctIndex, formulaId, explanation) {
            const options = document.querySelectorAll('.option');
            const isCorrect = selectedIndex === correctIndex;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            userProgress.totalAnswered = (userProgress.totalAnswered || 0) + 1;
            if (isCorrect) {
                userProgress.totalCorrect = (userProgress.totalCorrect || 0) + 1;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ñ–æ—Ä–º—É–ª–µ
            if (!userProgress.formulas) userProgress.formulas = {};
            if (!userProgress.formulas[formulaId]) {
                userProgress.formulas[formulaId] = {
                    correctCount: 0,
                    totalAttempts: 0,
                    lastAnswered: new Date().toISOString()
                };
            }
            
            userProgress.formulas[formulaId].totalAttempts++;
            userProgress.formulas[formulaId].lastAnswered = new Date().toISOString();
            
            if (isCorrect) {
                userProgress.formulas[formulaId].correctCount++;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            saveUserProgress();
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç—ã
            options.forEach((option, index) => {
                if (index === correctIndex) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && !isCorrect) {
                    option.classList.add('incorrect');
                }
                option.style.pointerEvents = 'none';
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            setTimeout(() => {
                document.getElementById('quizScreen').classList.add('hidden');
                document.getElementById('resultScreen').classList.remove('hidden');
                
                document.getElementById('resultTitle').textContent = isCorrect ? '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!' : '‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
                document.getElementById('resultMessage').textContent = isCorrect ? 
                    '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!' : '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑';
                document.getElementById('explanationText').textContent = explanation;
                
                // –ï—Å–ª–∏ —Ñ–æ—Ä–º—É–ª–∞ –≤—ã—É—á–µ–Ω–∞ (3+ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞)
                if (isCorrect && userProgress.formulas[formulaId].correctCount >= 3) {
                    document.getElementById('resultMessage').textContent += ' üéâ –§–æ—Ä–º—É–ª–∞ –≤—ã—É—á–µ–Ω–∞!';
                }
                
            }, 1000);
        }
        
        // –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        function nextQuestion() {
            currentQuestionIndex++;
            document.getElementById('resultScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            showQuestion();
        }
        
        // –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        function backToMain() {
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.add('hidden');
            document.getElementById('progressScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            updateUserStats();
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        function showProgress() {
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('progressScreen').classList.remove('hidden');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('progressTotalCorrect').textContent = userProgress.totalCorrect || 0;
            document.getElementById('progressTotalAnswered').textContent = userProgress.totalAnswered || 0;
            
            // –°—á–∏—Ç–∞–µ–º –≤—ã—É—á–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã
            const masteredFormulas = Object.values(userProgress.formulas || {}).filter(
                formula => formula.correctCount >= 3
            ).length;
            document.getElementById('masteredFormulas').textContent = masteredFormulas;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º
            renderTopicsProgress();
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º
        function renderTopicsProgress() {
            const topicsProgress = document.getElementById('topicsProgress');
            topicsProgress.innerHTML = '';
            
            for (const [topicKey, topicQuestions] of Object.entries(questions)) {
                const topicStats = calculateTopicProgress(topicKey);
                const progressPercent = topicStats.total > 0 ? (topicStats.learned / topicStats.total) * 100 : 0;
                
                const progressHTML = `
                    <div style="margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>${getTopicName(topicKey)}</strong>
                            <span>${topicStats.learned}/${topicStats.total}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                `;
                
                topicsProgress.innerHTML += progressHTML;
            }
        }

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–µ
        function calculateTopicProgress(topicKey) {
            const topicQuestions = questions[topicKey] || [];
            let learned = 0;
            
            topicQuestions.forEach(question => {
                const formulaProgress = userProgress.formulas?.[question.formulaId];
                if (formulaProgress && formulaProgress.correctCount >= 3) {
                    learned++;
                }
            });
            
            return {
                learned,
                total: topicQuestions.length
            };
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getTopicName(topicKey) {
            const names = {
                trigonometry: 'üìê –¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è',
                algebra: 'üî¢ –ê–ª–≥–µ–±—Ä–∞'
            };
            return names[topicKey] || topicKey;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            updateDebug('DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
            if (window.Telegram && Telegram.WebApp) {
                try {
                    const tg = Telegram.WebApp;
                    tg.ready();
                    updateDebug('Telegram –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                    
                    setTimeout(() => {
                        tg.expand();
                        updateDebug('–†–∞—Å—à–∏—Ä–µ–Ω–æ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω');
                    }, 500);
                    
                } catch (error) {
                    updateDebug('–û—à–∏–±–∫–∞ Telegram: ' + error.message);
                }
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            initUser();
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(e) {
            console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', e);
            updateDebug('–û–®–ò–ë–ö–ê: ' + e.message);
        });
    </script>
</body>
</html>
