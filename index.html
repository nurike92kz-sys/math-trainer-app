<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–Ω–∞–∂—ë—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            color: black;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .question {
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option:hover {
            background: #e9ecef;
        }
        
        .option.correct {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        
        .option.incorrect {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            width: 100%;
        }
        
        .topic-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 10px 0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .progress-section {
            margin: 20px 0;
        }
        
        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
        
        .formula-mastered {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .formula-learning {
            color: #FF9800;
        }
        
        .formula-new {
            color: #f44336;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loadingScreen">
            <div class="card">
                <div style="text-align: center; padding: 20px;">
                    <h2>üîÑ –ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                    <p>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à —É—á–µ–±–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</p>
                </div>
            </div>
        </div>

        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="mainScreen" class="hidden">
            <div class="header">
                <div class="user-info">
                    <div class="avatar" id="userAvatar">U</div>
                    <div>
                        <h3 id="userName">–£—á–µ–Ω–∏–∫</h3>
                        <p>–£—Ä–æ–≤–µ–Ω—å: <span id="userLevel">–ù–æ–≤–∏—á–æ–∫</span></p>
                    </div>
                </div>
                <h1>üéì –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–Ω–∞–∂—ë—Ä</h1>
            </div>
            
            <div class="card">
                <h3>üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="stats">
                    <div class="stat-item">
                        <div>‚úÖ</div>
                        <div id="totalCorrect">0</div>
                        <small>–ü—Ä–∞–≤–∏–ª—å–Ω–æ</small>
                    </div>
                    <div class="stat-item">
                        <div>üìù</div>
                        <div id="totalAnswered">0</div>
                        <small>–í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤</small>
                    </div>
                    <div class="stat-item">
                        <div>üéØ</div>
                        <div id="successRate">0%</div>
                        <small>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</small>
                    </div>
                </div>
                <div class="stat-item">
                    <div>üìö</div>
                    <div id="masteredFormulas">0</div>
                    <small>–í—ã—É—á–µ–Ω–æ —Ñ–æ—Ä–º—É–ª</small>
                </div>
            </div>

            <div class="card">
                <h3>üìö –í—ã–±–µ—Ä–∏ —Ç–µ–º—É:</h3>
                <div id="topicsContainer">
                    <!-- –¢–µ–º—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ -->
                </div>
            </div>
            
            <div class="card">
                <h3>üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º</h3>
                <div id="topicsProgress">
                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã -->
        <div id="quizScreen" class="hidden">
            <div class="header">
                <h2 id="topicTitle">–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è</h2>
                <p>–í–æ–ø—Ä–æ—Å <span id="currentQ">1</span> –∏–∑ <span id="totalQ">5</span></p>
            </div>
            
            <div class="card">
                <div class="question" id="questionText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="options" id="optionsContainer">
                    <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
            
            <div class="card hidden" id="resultCard">
                <h3 id="resultText"></h3>
                <p id="explanationText"></p>
                <button onclick="nextQuestion()">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ —Ñ–æ—Ä–º—É–ª–µ -->
        <div id="formulaProgressScreen" class="hidden">
            <div class="header">
                <h2>üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ñ–æ—Ä–º—É–ª–∞–º</h2>
                <button onclick="showMainScreen()">‚Üê –ù–∞–∑–∞–¥</button>
            </div>
            
            <div class="card">
                <h3 id="progressTopicTitle">–¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è</h3>
                <div id="formulasProgressContainer">
                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ñ–æ—Ä–º—É–ª–∞–º –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = null;
        if (window.Telegram && Telegram.WebApp) {
            tg = Telegram.WebApp;
            tg.ready();
            tg.expand();
            tg.setHeaderColor('#667eea');
            tg.setBackgroundColor('#667eea');
        }

        let questions = {};
        let currentTopic = '';
        let currentQuestionIndex = 0;
        let userProgress = {};
        let userId = '';

        // –°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π
        const levels = {
            1: { name: "–ù–æ–≤–∏—á–æ–∫", required: 0 },
            2: { name: "–£—á–µ–Ω–∏–∫", required: 10 },
            3: { name: "–ó–Ω–∞—Ç–æ–∫", required: 25 },
            4: { name: "–≠–∫—Å–ø–µ—Ä—Ç", required: 50 },
            5: { name: "–ú–∞—Å—Ç–µ—Ä", required: 100 }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function initUser() {
            // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const telegramUser = tg.initDataUnsafe.user;
                userId = telegramUser.id.toString();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                document.getElementById('userName').textContent = 
                    telegramUser.first_name || '–£—á–µ–Ω–∏–∫';
                document.getElementById('userAvatar').textContent = 
                    telegramUser.first_name ? telegramUser.first_name[0].toUpperCase() : 'U';
            } else {
                // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram
                userId = 'test_user_' + Date.now();
                document.getElementById('userName').textContent = '–£—á–µ–Ω–∏–∫ (—Ç–µ—Å—Ç)';
                document.getElementById('userAvatar').textContent = 'T';
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            loadUserProgress();
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserProgress() {
            const savedProgress = localStorage.getItem(`math_progress_${userId}`);
            
            if (savedProgress) {
                userProgress = JSON.parse(savedProgress);
                console.log('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω:', userProgress);
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å
                userProgress = {
                    userId: userId,
                    totalCorrect: 0,
                    totalAnswered: 0,
                    formulas: {},
                    topics: {},
                    level: 1,
                    createdAt: new Date().toISOString()
                };
                saveUserProgress();
                console.log('‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å');
            }
            
            updateUserStats();
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveUserProgress() {
            localStorage.setItem(`math_progress_${userId}`, JSON.stringify(userProgress));
            
            // –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
            if (tg) {
                tg.sendData(JSON.stringify({
                    action: 'save_progress',
                    progress: userProgress
                }));
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –∏–∑ JSON
        async function loadQuestions() {
            try {
                const response = await fetch('questions.json');
                questions = await response.json();
                console.log('‚úÖ –í–æ–ø—Ä–æ—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                showMainScreen();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã: ${error.message}`);
            }
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        function showMainScreen() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            
            updateUserStats();
            renderTopics();
            renderTopicsProgress();
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateUserStats() {
            document.getElementById('totalCorrect').textContent = userProgress.totalCorrect || 0;
            document.getElementById('totalAnswered').textContent = userProgress.totalAnswered || 0;
            
            const successRate = userProgress.totalAnswered > 0 
                ? Math.round((userProgress.totalCorrect / userProgress.totalAnswered) * 100) 
                : 0;
            document.getElementById('successRate').textContent = successRate + '%';
            
            // –°—á–∏—Ç–∞–µ–º –≤—ã—É—á–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã (–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–≤–µ—á–µ–Ω—ã 3+ —Ä–∞–∑–∞)
            const masteredFormulas = Object.values(userProgress.formulas || {}).filter(
                formula => formula.correctCount >= 3
            ).length;
            document.getElementById('masteredFormulas').textContent = masteredFormulas;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
            const userLevel = calculateUserLevel();
            document.getElementById('userLevel').textContent = levels[userLevel].name;
        }

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function calculateUserLevel() {
            const totalCorrect = userProgress.totalCorrect || 0;
            
            for (let level = 5; level >= 1; level--) {
                if (totalCorrect >= levels[level].required) {
                    userProgress.level = level;
                    return level;
                }
            }
            return 1;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫ —Ç–µ–º
        function renderTopics() {
            const topicsContainer = document.getElementById('topicsContainer');
            topicsContainer.innerHTML = '';
            
            const topicNames = {
                trigonometry: 'üìê –¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è',
                algebra: 'üî¢ –ê–ª–≥–µ–±—Ä–∞', 
                geometry: 'üìè –ì–µ–æ–º–µ—Ç—Ä–∏—è',
                logarithms: 'üìä –õ–æ–≥–∞—Ä–∏—Ñ–º—ã'
            };
            
            for (const [topicKey, topicName] of Object.entries(topicNames)) {
                if (questions[topicKey] && questions[topicKey].length > 0) {
                    const button = document.createElement('button');
                    button.className = 'topic-btn';
                    button.innerHTML = `${topicName} <small>(${questions[topicKey].length} —Ñ–æ—Ä–º—É–ª)</small>`;
                    button.onclick = () => startTopic(topicKey);
                    topicsContainer.appendChild(button);
                    
                    // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    const progressBtn = document.createElement('button');
                    progressBtn.innerHTML = `üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ ${topicName}`;
                    progressBtn.onclick = () => showFormulaProgress(topicKey);
                    progressBtn.style.background = '#28a745';
                    topicsContainer.appendChild(progressBtn);
                }
            }
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–∞–º
        function renderTopicsProgress() {
            const topicsProgress = document.getElementById('topicsProgress');
            topicsProgress.innerHTML = '';
            
            for (const [topicKey, topicQuestions] of Object.entries(questions)) {
                if (!topicQuestions) continue;
                
                const topicStats = calculateTopicProgress(topicKey);
                const progressPercent = topicStats.total > 0 ? (topicStats.learned / topicStats.total) * 100 : 0;
                
                const progressHTML = `
                    <div class="progress-item">
                        <div>
                            <strong>${getTopicName(topicKey)}</strong>
                            <div>${topicStats.learned}/${topicStats.total} —Ñ–æ—Ä–º—É–ª –∏–∑—É—á–µ–Ω–æ</div>
                        </div>
                        <div style="width: 100px;">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <div style="text-align: center; font-size: 12px;">${Math.round(progressPercent)}%</div>
                        </div>
                    </div>
                `;
                
                topicsProgress.innerHTML += progressHTML;
            }
        }

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ç–µ–º–µ
        function calculateTopicProgress(topicKey) {
            const topicQuestions = questions[topicKey] || [];
            let learned = 0;
            
            topicQuestions.forEach(question => {
                const formulaProgress = userProgress.formulas?.[question.formulaId];
                if (formulaProgress && formulaProgress.correctCount >= 3) {
                    learned++;
                }
            });
            
            return {
                learned,
                total: topicQuestions.length
            };
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ñ–æ—Ä–º—É–ª–∞–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–µ–º—ã
        function showFormulaProgress(topicKey) {
            currentTopic = topicKey;
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('formulaProgressScreen').classList.remove('hidden');
            
            document.getElementById('progressTopicTitle').textContent = getTopicName(topicKey);
            
            const container = document.getElementById('formulasProgressContainer');
            container.innerHTML = '';
            
            questions[topicKey].forEach(question => {
                const formulaProgress = userProgress.formulas?.[question.formulaId] || {
                    correctCount: 0,
                    totalAttempts: 0,
                    lastAnswered: null
                };
                
                const status = formulaProgress.correctCount >= 3 ? 'formula-mastered' : 
                              formulaProgress.correctCount > 0 ? 'formula-learning' : 'formula-new';
                
                const statusText = formulaProgress.correctCount >= 3 ? '‚úÖ –í—ã—É—á–µ–Ω–∞' :
                                 formulaProgress.correctCount > 0 ? 'üü° –ò–∑—É—á–∞–µ—Ç—Å—è' : 'üî¥ –ù–æ–≤–∞—è';
                
                const formulaHTML = `
                    <div class="progress-item">
                        <div>
                            <div class="${status}">${question.question}</div>
                            <small>${statusText} | –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${formulaProgress.correctCount}/3</small>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${(formulaProgress.correctCount / 3) * 100}%"></div>
                        </div>
                    </div>
                `;
                
                container.innerHTML += formulaHTML;
            });
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ–º—É
        function startTopic(topic) {
            currentTopic = topic;
            currentQuestionIndex = 0;
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã
            shuffleArray(questions[topic]);
            
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            document.getElementById('topicTitle').textContent = getTopicName(topic);
            document.getElementById('totalQ').textContent = questions[topic].length;
            
            showQuestion();
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å
        function showQuestion() {
            const question = questions[currentTopic][currentQuestionIndex];
            const optionsContainer = document.getElementById('optionsContainer');
            const resultCard = document.getElementById('resultCard');
            
            optionsContainer.innerHTML = '';
            resultCard.classList.add('hidden');
            
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
            
            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã
            const shuffledOptions = [...question.options];
            shuffleArray(shuffledOptions);
            const correctAnswerIndex = shuffledOptions.indexOf(question.options[question.correct]);
            
            shuffledOptions.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.onclick = () => checkAnswer(index, correctAnswerIndex, question.formulaId);
                optionsContainer.appendChild(optionElement);
            });
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
        function checkAnswer(selectedIndex, correctIndex, formulaId) {
            const options = document.querySelectorAll('.option');
            const resultCard = document.getElementById('resultCard');
            const resultText = document.getElementById('resultText');
            const explanationText = document.getElementById('explanationText');
            
            options.forEach(opt => opt.style.pointerEvents = 'none');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            userProgress.totalAnswered = (userProgress.totalAnswered || 0) + 1;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —Ñ–æ—Ä–º—É–ª–µ
            if (!userProgress.formulas) userProgress.formulas = {};
            if (!userProgress.formulas[formulaId]) {
                userProgress.formulas[formulaId] = {
                    correctCount: 0,
                    totalAttempts: 0,
                    lastAnswered: new Date().toISOString()
                };
            }
            
            userProgress.formulas[formulaId].totalAttempts++;
            userProgress.formulas[formulaId].lastAnswered = new Date().toISOString();
            
            if (selectedIndex === correctIndex) {
                options[selectedIndex].classList.add('correct');
                resultText.textContent = '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
                resultText.style.color = '#4CAF50';
                
                userProgress.totalCorrect = (userProgress.totalCorrect || 0) + 1;
                userProgress.formulas[formulaId].correctCount++;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã—É—á–∏–ª –ª–∏ —Ñ–æ—Ä–º—É–ª—É
                if (userProgress.formulas[formulaId].correctCount >= 3) {
                    resultText.textContent += ' üéâ –§–æ—Ä–º—É–ª–∞ –≤—ã—É—á–µ–Ω–∞!';
                }
            } else {
                options[selectedIndex].classList.add('incorrect');
                options[correctIndex].classList.add('correct');
                resultText.textContent = '‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
                resultText.style.color = '#f44336';
            }
            
            explanationText.textContent = questions[currentTopic][currentQuestionIndex].explanation;
            resultCard.classList.remove('hidden');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            saveUserProgress();
        }

        // –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        function nextQuestion() {
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= questions[currentTopic].length) {
                // –ö–æ–Ω–µ—Ü –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
                if (tg) {
                    tg.showPopup({
                        title: 'üéâ –¢–µ–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!',
                        message: `–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${userProgress.totalCorrect}/${userProgress.totalAnswered}\n–í—ã—É—á–µ–Ω–æ —Ñ–æ—Ä–º—É–ª: ${Object.values(userProgress.formulas).filter(f => f.correctCount >= 3).length}`
                    });
                }
                
                showMainScreen();
            } else {
                showQuestion();
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getTopicName(topicKey) {
            const names = {
                trigonometry: 'üìê –¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è',
                algebra: 'üî¢ –ê–ª–≥–µ–±—Ä–∞', 
                geometry: 'üìè –ì–µ–æ–º–µ—Ç—Ä–∏—è',
                logarithms: 'üìä –õ–æ–≥–∞—Ä–∏—Ñ–º—ã'
            };
            return names[topicKey] || topicKey;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function showMainScreen() {
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('formulaProgressScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            updateUserStats();
            renderTopicsProgress();
        }

        function showError(message) {
            // –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
            alert('–û—à–∏–±–∫–∞: ' + message);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        document.addEventListener('DOMContentLoaded', function() {
            initUser();
            loadQuestions();
        });
    </script>
</body>
</html>
