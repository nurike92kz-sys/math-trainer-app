<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.setHeaderColor('#667eea');
        Telegram.WebApp.setBackgroundColor('#667eea');
    }

    let questions = {};
    let currentTopic = '';
    let currentQuestionIndex = 0;
    let correctAnswers = 0;
    let totalAnswers = 0;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –∏–∑ JSON —Ñ–∞–π–ª–∞
    async function loadQuestions() {
        try {
            console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤–æ–ø—Ä–æ—Å–æ–≤...');
            const response = await fetch('questions.json');
            
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
            }
            
            questions = await response.json();
            console.log('‚úÖ –í–æ–ø—Ä–æ—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', questions);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
            showMainScreen();
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã: ${error.message}`);
        }
    }

    function showMainScreen() {
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('mainScreen').classList.remove('hidden');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        updateStats();
    }

    function showError(message) {
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('errorScreen').classList.remove('hidden');
        document.getElementById('errorMessage').textContent = message;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫ (startQuiz –≤–º–µ—Å—Ç–æ startTopic)
    function startQuiz(topic) {
        currentTopic = topic;
        currentQuestionIndex = 0;
        correctAnswers = 0;
        totalAnswers = 0;
        updateStats();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã
        if (!questions[topic] || questions[topic].length === 0) {
            alert('–í–æ–ø—Ä–æ—Å—ã –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            return;
        }
        
        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã
        shuffleArray(questions[topic]);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
        document.getElementById('mainScreen').classList.add('hidden');
        document.getElementById('quizScreen').classList.remove('hidden');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã
        const topicNames = {
            trigonometry: 'üìê –¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è',
            logarithms: 'üìä –õ–æ–≥–∞—Ä–∏—Ñ–º—ã',
            derivatives: 'üìà –ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ'
        };
        document.getElementById('topicTitle').textContent = topicNames[topic] || topic;
        document.getElementById('totalQ').textContent = questions[topic].length;
        
        showQuestion();
    }

    function showQuestion() {
        if (!questions[currentTopic] || currentQuestionIndex >= questions[currentTopic].length) {
            endQuiz();
            return;
        }
        
        const question = questions[currentTopic][currentQuestionIndex];
        const optionsContainer = document.getElementById('optionsContainer');
        const resultCard = document.getElementById('resultCard');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        optionsContainer.innerHTML = '';
        resultCard.classList.add('hidden');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å
        document.getElementById('questionText').textContent = question.question;
        document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
        
        // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
        const shuffledOptions = [...question.options];
        shuffleArray(shuffledOptions);
        const correctAnswerIndex = shuffledOptions.indexOf(question.options[question.correct]);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
        shuffledOptions.forEach((option, index) => {
            const optionElement = document.createElement('div');
            optionElement.className = 'option';
            optionElement.textContent = option;
            optionElement.onclick = () => checkAnswer(index, correctAnswerIndex, question.explanation);
            optionsContainer.appendChild(optionElement);
        });
    }

    function checkAnswer(selectedIndex, correctIndex, explanation) {
        const options = document.querySelectorAll('.option');
        const resultCard = document.getElementById('resultCard');
        const resultText = document.getElementById('resultText');
        const explanationText = document.getElementById('explanationText');
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
        options.forEach(opt => opt.style.pointerEvents = 'none');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        totalAnswers++;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
        if (selectedIndex === correctIndex) {
            options[selectedIndex].classList.add('correct');
            resultText.textContent = '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
            resultText.style.color = '#4CAF50';
            correctAnswers++;
        } else {
            options[selectedIndex].classList.add('incorrect');
            options[correctIndex].classList.add('correct');
            resultText.textContent = '‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
            resultText.style.color = '#f44336';
        }
        
        explanationText.textContent = explanation;
        resultCard.classList.remove('hidden');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
        updateStats();
    }

    function nextQuestion() {
        currentQuestionIndex++;
        
        if (currentQuestionIndex >= questions[currentTopic].length) {
            endQuiz();
        } else {
            showQuestion();
        }
    }

    function endQuiz() {
        // –ö–æ–Ω–µ—Ü –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.showPopup({
                title: 'üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!',
                message: `–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ç–µ–º—É! –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${correctAnswers}/${questions[currentTopic].length}`
            });
        }
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        backToMain();
    }

    function backToMain() {
        document.getElementById('quizScreen').classList.add('hidden');
        document.getElementById('resultCard').classList.add('hidden');
        document.getElementById('mainScreen').classList.remove('hidden');
    }

    function showProgress() {
        alert(`üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n\n‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${correctAnswers}\nüìù –í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤: ${totalAnswers}\nüéØ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: ${totalAnswers > 0 ? Math.round((correctAnswers / totalAnswers) * 100) : 0}%`);
    }

    function updateStats() {
        document.getElementById('correctCount').textContent = correctAnswers;
        document.getElementById('totalCount').textContent = totalAnswers;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è –º–∞—Å—Å–∏–≤–∞
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    document.addEventListener('DOMContentLoaded', loadQuestions);
</script>
