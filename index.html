<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let tg = null;
    let isTelegram = false;
    let currentTopic = '';
    let currentQuestionIndex = 0;
    
    // –ü—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const simpleQuestions = {
        trigonometry: [
            {
                question: "–ß–µ–º—É —Ä–∞–≤–µ–Ω sin(90¬∞)?",
                options: ["0", "1", "-1", "0.5"],
                correct: 1,
                explanation: "sin(90¬∞) = 1"
            },
            {
                question: "–ß–µ–º—É —Ä–∞–≤–µ–Ω cos(0¬∞)?",
                options: ["0", "1", "-1", "0.5"], 
                correct: 1,
                explanation: "cos(0¬∞) = 1"
            }
        ],
        algebra: [
            {
                question: "–ß–µ–º—É —Ä–∞–≤–µ–Ω (a + b)¬≤?",
                options: ["a¬≤ + 2ab + b¬≤", "a¬≤ + b¬≤", "a¬≤ - 2ab + b¬≤", "a¬≤ - b¬≤"],
                correct: 0,
                explanation: "(a + b)¬≤ = a¬≤ + 2ab + b¬≤"
            }
        ]
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    function updateDebug(message) {
        const debug = document.getElementById('debugInfo');
        if (debug) {
            debug.innerHTML = message + '<br>' + debug.innerHTML;
        }
        console.log('DEBUG:', message);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    function updateLoading(text) {
        const loadingText = document.getElementById('loadingText');
        if (loadingText) {
            loadingText.textContent = text;
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    function initTelegram() {
        updateDebug('1. –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram Web App...');
        
        if (window.Telegram && Telegram.WebApp) {
            updateDebug('2. Telegram Web App –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
            tg = Telegram.WebApp;
            isTelegram = true;
            
            try {
                tg.ready();
                updateDebug('3. tg.ready() —É—Å–ø–µ—à–Ω–æ');
                
                setTimeout(() => {
                    updateDebug('4. –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω');
                    tg.expand();
                    tg.setHeaderColor('#667eea');
                    tg.setBackgroundColor('#667eea');
                    updateDebug('5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                    showUserInfo();
                    
                }, 100);
                
            } catch (error) {
                updateDebug('–û–®–ò–ë–ö–ê Telegram: ' + error.message);
                handleTelegramError();
            }
        } else {
            updateDebug('2. –†–∞–±–æ—Ç–∞–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
            isTelegram = false;
            handleNonTelegram();
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Telegram
    function handleTelegramError() {
        updateDebug('–ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º –±—Ä–∞—É–∑–µ—Ä–∞');
        isTelegram = false;
        showMainScreen();
    }

    // –†–µ–∂–∏–º –±–µ–∑ Telegram
    function handleNonTelegram() {
        updateDebug('–ó–∞–ø—É—Å–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–Ω–æ–º —Ä–µ–∂–∏–º–µ');
        setTimeout(() => {
            showMainScreen();
        }, 1000);
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    function showUserInfo() {
        const userInfo = document.getElementById('userInfo');
        
        if (isTelegram && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const user = tg.initDataUnsafe.user;
            userInfo.innerHTML = `
                <h3>üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:</h3>
                <p><strong>–ò–º—è:</strong> ${user.first_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                <p><strong>ID:</strong> ${user.id}</p>
                <p><strong>–Ø–∑—ã–∫:</strong> ${user.language_code || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
            `;
        } else {
            userInfo.innerHTML = `
                <h3>üë§ –ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º</h3>
                <p>–í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</p>
            `;
        }
        
        showMainScreen();
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
    function showMainScreen() {
        updateDebug('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω');
        updateLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        
        setTimeout(() => {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
        }, 500);
    }

    // –ó–ê–ü–£–°–ö–ê–ï–ú –¢–ï–ú–£ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
    function startTopic(topic) {
        updateDebug('–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ–º—É: ' + topic);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É
        currentTopic = topic;
        currentQuestionIndex = 0;
        
        // –ü—Ä—è—á–µ–º –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∫—Ç–æ—Ä–∏–Ω—É
        document.getElementById('mainScreen').classList.add('hidden');
        document.getElementById('quizScreen').classList.remove('hidden');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã
        const topicNames = {
            trigonometry: 'üìê –¢—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—è',
            algebra: 'üî¢ –ê–ª–≥–µ–±—Ä–∞'
        };
        
        document.getElementById('topicTitle').textContent = topicNames[topic] || topic;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
        showCurrentQuestion();
    }

    // –ü–û–ö–ê–ó–´–í–ê–ï–ú –¢–ï–ö–£–©–ò–ô –í–û–ü–†–û–°
    function showCurrentQuestion() {
        updateDebug('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å ' + currentQuestionIndex + ' –¥–ª—è —Ç–µ–º—ã ' + currentTopic);
        
        const questions = simpleQuestions[currentTopic];
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–æ–ø—Ä–æ—Å—ã
        if (!questions || questions.length === 0) {
            updateDebug('–û–®–ò–ë–ö–ê: –ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ç–µ–º—ã ' + currentTopic);
            backToMain();
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—à–ª–∏ –ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã
        if (currentQuestionIndex >= questions.length) {
            updateDebug('–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ–π–¥–µ–Ω—ã');
            backToMain();
            return;
        }
        
        const question = questions[currentQuestionIndex];
        const optionsContainer = document.getElementById('optionsContainer');
        const resultCard = document.getElementById('resultCard');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        optionsContainer.innerHTML = '';
        resultCard.classList.add('hidden');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å
        document.getElementById('questionText').textContent = question.question;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
        question.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.textContent = option;
            button.onclick = function() {
                checkAnswer(index, question.correct, question.explanation);
            };
            optionsContainer.appendChild(button);
        });
        
        updateDebug('–í–æ–ø—Ä–æ—Å –ø–æ–∫–∞–∑–∞–Ω: ' + question.question);
    }

    // –ü–†–û–í–ï–†–Ø–ï–ú –û–¢–í–ï–¢
    function checkAnswer(selectedIndex, correctIndex, explanation) {
        updateDebug('–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç: –≤—ã–±—Ä–∞–Ω ' + selectedIndex + ', –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ' + correctIndex);
        
        const resultCard = document.getElementById('resultCard');
        const resultText = document.getElementById('resultText');
        const explanationText = document.getElementById('explanationText');
        const optionsContainer = document.getElementById('optionsContainer');
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
        const buttons = optionsContainer.getElementsByTagName('button');
        for (let button of buttons) {
            button.disabled = true;
        }
        
        if (selectedIndex === correctIndex) {
            resultText.textContent = '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
            resultText.style.color = '#4CAF50';
        } else {
            resultText.textContent = '‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
            resultText.style.color = '#f44336';
        }
        
        explanationText.textContent = explanation;
        resultCard.classList.remove('hidden');
        
        updateDebug('–û—Ç–≤–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω');
    }

    // –°–õ–ï–î–£–Æ–©–ò–ô –í–û–ü–†–û–°
    function nextQuestion() {
        currentQuestionIndex++;
        showCurrentQuestion();
    }

    // –ù–ê–ó–ê–î –ù–ê –ì–õ–ê–í–ù–£–Æ
    function backToMain() {
        updateDebug('–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é');
        document.getElementById('quizScreen').classList.add('hidden');
        document.getElementById('resultCard').classList.add('hidden');
        document.getElementById('mainScreen').classList.remove('hidden');
    }

    // –ü–û–ö–ê–ó–´–í–ê–ï–ú –ò–ù–§–û–†–ú–ê–¶–ò–Æ –û TELEGRAM
    function showTelegramInfo() {
        let info = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Telegram Web App:\n\n';
        info += 'isTelegram: ' + isTelegram + '\n';
        
        if (tg) {
            info += 'tg.version: ' + (tg.version || 'N/A') + '\n';
            info += 'tg.platform: ' + (tg.platform || 'N/A') + '\n';
            info += 'tg.initData: ' + (tg.initData ? '–ï—Å—Ç—å' : '–ù–µ—Ç') + '\n';
            
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                info += 'user: ' + tg.initDataUnsafe.user.first_name + '\n';
            }
        }
        
        alert(info);
    }

    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´
    document.addEventListener('DOMContentLoaded', function() {
        updateDebug('0. DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
        updateLoading('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
        
        setTimeout(() => {
            initTelegram();
        }, 100);
    });

    // –û–ë–†–ê–ë–û–¢–ß–ò–ö –û–®–ò–ë–û–ö
    window.addEventListener('error', function(e) {
        updateDebug('–ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –û–®–ò–ë–ö–ê: ' + e.message);
        console.error('Global error:', e);
    });
</script>
